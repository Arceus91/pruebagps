<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seguimiento y ruta suavizada</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

<style>
  #map { height: 90vh; width: 100%; }
</style>
</head>
<body>
<h2 style="text-align:center">Mi ubicación y ruta hacia destino (GPS suavizado)</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
  // Coordenadas del destino
  const destino = [14.639000, -90.511000]; // cambia por tu destino

  // Inicializa el mapa
  const map = L.map('map').setView([0,0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 19
  }).addTo(map);

  // Marcador del destino
  const destinoMarker = L.marker(destino, {title: "Destino"}).addTo(map)
                          .bindPopup("Destino").openPopup();

  // Marcador de mi ubicación
  const miMarker = L.marker([0,0], {title: "Mi ubicación"}).addTo(map);

  // Polilínea para mostrar recorrido
  const path = L.polyline([], {color: 'blue'}).addTo(map);

  // Control de ruta
  let routingControl;

  // Buffer para suavizado GPS
  const buffer = [];
  const maxBuffer = 10; // cantidad de posiciones para promedio

  if(navigator.geolocation) {
    navigator.geolocation.watchPosition((position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // Agregar posición al buffer
      buffer.push([lat,lng]);
      if(buffer.length > maxBuffer) buffer.shift();

      // Calcular promedio
      const promedio = buffer.reduce((acc, p) => [acc[0]+p[0], acc[1]+p[1]], [0,0])
                               .map(v => v / buffer.length);

      // Mover marcador suavizado
      miMarker.setLatLng(promedio);

      // Añadir punto a la polilínea
      path.addLatLng(promedio);

      // Centrar mapa
      map.panTo(promedio);

      // Crear o actualizar ruta hacia destino
      if(routingControl) {
        routingControl.setWaypoints([L.latLng(promedio[0], promedio[1]), L.latLng(destino[0], destino[1])]);
      } else {
        routingControl = L.Routing.control({
          waypoints: [L.latLng(promedio[0], promedio[1]), L.latLng(destino[0], destino[1])],
          routeWhileDragging: false,
          addWaypoints: false,
          draggableWaypoints: false
        }).addTo(map);
      }

    }, (error) => {
      console.error("Error al obtener ubicación:", error);
      alert("No se pudo obtener la ubicación. Asegúrate de permitir el acceso.");
    }, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
  } else {
    alert("Tu navegador no soporta geolocalización");
  }

</script>
</body>
</html>
